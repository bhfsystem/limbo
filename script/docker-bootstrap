#!/usr/bin/env bash

set -x

function main {
  if sudo lvs system/thinpool-data; then
    if ! sudo lvs system/thinpool-data | awk 'NR == 2 { print $3 }' | grep ^t; then
      sudo lvremove -f system/thinpool-data 2>&- >/dev/null || true
      #sudo lvcreate -T -L 20G --poolmetadatasize 4G system/thinpool-data
    fi
  fi

  local nm_driver="$(sudo docker info 2>&- | awk '/Storage Drive/ { print $3 }')"
  if [[ "$nm_driver" != "overlay2" ]]; then
    sudo service docker stop 2>&- || true
    sudo groupadd docker 2>&- || true
    sudo usermod -aG docker ubuntu
    sudo rm -rf /var/lib/docker 
    cat << ____EOF | sudo tee /etc/default/docker
    DOCKER_OPTS='
    -H tcp://0.0.0.0:2376
    -H unix:///var/run/docker.sock
    --storage-driver overlay2
    '
____EOF
  fi
}

main "$@"
