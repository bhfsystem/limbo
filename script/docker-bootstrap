#!/usr/bin/env bash

set -x

function main {
  source /etc/lsb-release
  export DEBIAN_FRONTEND=noninteractive

  case "$DISTRIB_CODENAME" in
    trusty)
      sudo -E apt-add-repository -y ppa:zfs-native/stable
      sudo -E aptitude update
      sudo -E aptitude install -y ubuntu-zfs dkms
      ;;

    xenial)
      sudo -E aptitude install -y zfsutils-linux
      true
      ;;
  esac

  sudo modprobe zfs || true
  if sudo zpool create data /dev/mapper/system-zfs 2>/dev/null; then
    sudo zfs create -o mountpoint=/var/lib/docker data/docker
    sudo groupadd docker 2>/dev/null || true
    sudo usermod -aG docker ubuntu
    cat <<__EOF | sudo tee /etc/default/docker
DOCKER_OPTS='
-H tcp://0.0.0.0:2376
-H unix:///var/run/docker.sock
--storage-driver zfs
'
__EOF
  fi

  sudo zpool list
  sudo zfs list
}

main "$@"
