#!/usr/bin/env bash

function main {
  local net_bridge="$1"; shift
  local cache_vip="$1"; shift

  set -x

  source /etc/lsb-release
  export DEBIAN_FRONTEND=noninteractive


  local use_btrfs=
  if sudo lvs system/thinpool-data 1>/dev/null 2>&1; then
    if ! sudo lvs system/thinpool-data | awk 'NR == 2 { print $3 }' | grep ^t; then
      sudo lvremove -f system/thinpool-data 2>/dev/null >/dev/null || true

      if [[ -n "$use_btrfs" ]]; then
        sudo -E apt-get install -y btrfs-tools
        sudo lvcreate -n btrfs -L 30G system
        sudo mkfs.btrfs /dev/system/btrfs
        sudo mkdir /var/lib/lxd
        sudo mount -o user_subvol_rm_allowed /dev/system/btrfs /var/lib/lxd
      else
        sudo lxc config set storage.lvm_vg_name system
      fi
    fi
  fi

  case "$DISTRIB_CODENAME" in
    trusty)
      sudo -E add-apt-repository -y ppa:ubuntu-lxc/lxd-stable
      sudo -E aptitude update
      ;;

  esac

  sudo -E aptitude install -y lxd
  sudo service lxd stop 2>/dev/null || true

  cat <<EOF | sudo tee /etc/default/lxd-bridge
USE_LXD_BRIDGE="true"
LXD_BRIDGE="lxdbr0"
UPDATE_PROFILE="true"
LXD_CONFILE=""
LXD_DOMAIN="lxd"
LXD_IPV4_ADDR="${net_bridge}.1"
LXD_IPV4_NETMASK="255.255.255.0"
LXD_IPV4_NETWORK="${net_bridge}.1/24"
LXD_IPV4_DHCP_RANGE="${net_bridge}.10,${net_bridge}.200"
LXD_IPV4_DHCP_MAX="191"
LXD_IPV4_NAT="true"
LXD_IPV6_ADDR=""
LXD_IPV6_MASK=""
LXD_IPV6_NETWORK=""
LXD_IPV6_NAT="false"
LXD_IPV6_PROXY="false"
EOF

  sudo service lxd start

  sudo lxc config set core.https_address [::]
  sudo lxc config set core.trust_password ubuntu

  sudo usermod -aG lxd ubuntu

  sudo chown -R ubuntu:ubuntu ~ubuntu/.config
}

main "$@"
