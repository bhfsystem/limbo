#!/usr/bin/env bash

export VAGRANT_DEFAULT_PROVIDER="docker"

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  export VAGRANT_CWD="$shome"

  if [[ "$#" == 0 ]]; then
    echo "$(basename "$0"): up|destroy ssh|rsync|scp id media rebuild build|remove"
    return 0
  fi

  local nm_guest="$(basename "$0")"
  local nm_action="$1"; shift

  case "$(uname -s)" in
    Darwin)
      case "$nm_action" in
        ssh)
          ${BOX_NAME} ssh -t "$nm_guest $nm_action $*"
          ;;
        *)
          ${BOX_NAME} ssh "source .bash_profile; require; $nm_guest $nm_action $*"
          ;;
      esac
      return $?
      ;;
  esac

  local nm_provider='docker'

  case "$nm_action" in
    media)
      if [[ "$nm_guest" == "${BOX_NAME}0" ]]; then
        export BASEBOX_DOCKER_IMAGE="ubuntu:latest"
        export BASEBOX_DOCKER_TAG="packer"
        docker build
      else
        export BASEBOX_DOCKER_TAG="vagrant"
        docker commit "$(${BOX_NAME}0 id)" "ubuntu:${BASEBOX_DOCKER_TAG}"
      fi
      ;;
    export)
      if [[ "$nm_guest" == "${BOX_NAME}0" ]]; then
        local nm_docker_image="ubuntu:vagrant"
      else
        local nm_docker_image="ubuntu:vagrant-${nm_guest}"
      fi
      docker commit "$($nm_guest id)" "${nm_docker_image}"
      ;;
    rebuild)
      if [[ "$nm_guest" == "${BOX_NAME}0" ]]; then
        export BASEBOX_DOCKER_IMAGE="ubuntu:vagrant"
        export BASEBOX_DOCKER_TAG="vagrant"
        docker build
      else
        export BASEBOX_DOCKER_IMAGE="ubuntu:vagrant-${nm_guest}"
        export BASEBOX_DOCKER_TAG="vagrant-${nm_guest}"
      fi
      "$nm_guest" destroy -f
      "$nm_guest" up
      ;;
    up)
      parity "$nm_action" "$nm_guest" "$@"
      ;;
    destroy)
      vagrant "$nm_action" "$nm_guest" "$@"
      ;;
    ssh|rsync|scp)
      parity "$nm_action" "$nm_guest" "$@"
      ;;
    id)
      cat "$(set +f; ls -td "$VAGRANT_CWD/.vagrant/machines/$nm_guest"/*/id | head -1)"; echo
      ;;
    build)
      "$nm_guest" destroy -f
      "$nm_guest" up
      ;;
    *)
      vagrant "$nm_action" "$nm_guest" "$@"
      ;;
  esac
}

source sub "$BASH_SOURCE" "$@"
