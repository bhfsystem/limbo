#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"
  source "$shome/script/profile"

  local ip_consul="${CONSUL_SERVER:-$(docker-machine ip reality)}"
  ssh -o StrictHostKeyChecking=no ubuntu@"$BASEBOX_IP" sudo service docker start || true
  "$BASEBOX_INSTANCE" docker machine rm -f "$BASEBOX_INSTANCE"
  exec "$BASEBOX_INSTANCE" docker machine create --driver generic --generic-ip-address "$BASEBOX_IP" --generic-ssh-user ubuntu \
    --swarm \
    --swarm-discovery="consul://${CONSUL_SERVER}:8500" \
    --engine-storage-driver="devicemapper" \
    --engine-opt="cluster-store=consul://${CONSUL_SERVER}:8500" \
    --engine-opt="cluster-advertise=eth1:2376" \
    --engine-opt="bridge=br0" \
    "$@" \
    "$BASEBOX_INSTANCE"
}

source sub "$BASH_SOURCE" "$@"
