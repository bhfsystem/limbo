#!/usr/bin/env bash

TMPDIR="${BASEBOX_CACHE}/tmp"
mkdir -p "$TMPDIR"

function box_main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  export VAGRANT_CWD="$shome${BASEBOX_INSTANCE:+/instance/${BASEBOX_INSTANCE}}-${VAGRANT_DEFAULT_PROVIDER}"
  
  if [[ "$VAGRANT_CWD" != "$shome" ]]; then
    mkdir -p "$VAGRANT_CWD"
    ln -nfs "$shome/Vagrantfile" "$VAGRANT_CWD/"
    ln -nfs "$shome/script" "$VAGRANT_CWD/"
    ln -nfs "$shome/.ssh" "$VAGRANT_CWD/"
  fi 

  if [[ "$#" == 0 ]]; then
    echo "$(basename "$0"): up|destroy ssh|rsync|scp id media build export rebuild"
    return 0
  fi

  local nm_action="$1"; shift
  local nm_guest=
  local cmd_guest=
  local nm_rebuilder=

  local nm_basebox_build=
  local basebox_type=

  set -x

  case "$VAGRANT_DEFAULT_PROVIDER" in
    vmware_fusion)
      nm_guest="${BASEBOX_NAME}"
      cmd_guest="limbo vmware"
      nm_rebuilder='vmware'

      nm_basebox_build='ubuntu'
      basebox_type='vmx'
      ;;
    virtualbox)
      nm_guest="${BASEBOX_NAME}"
      cmd_guest="limbo virtualbox"
      nm_rebuilder='virtualbox'

      nm_basebox_build='ubuntu'
      basebox_type='ovf'
      ;;
    parallels)
      nm_guest="${BASEBOX_NAME}"
      cmd_guest="limbo parallels"
      nm_rebuilder='parallels'

      nm_basebox_build='ubuntu'
      basebox_type='pvm'
      ;;
    docker)
      nm_guest="${BASEBOX_NAME}"
      cmd_guest="limbo docker"
      nm_rebuilder='docker'
      ;;
    aws)
      nm_guest="${BASEBOX_NAME}"
      cmd_guest="limbo aws"
      nm_rebuilder="aws"
      ;;
    *)
      echo "ERROR: unknown provider $VAGRANT_DEFAULT_PROVIDER" 1>&2
      return 1
      ;;
  esac

  case "$nm_action" in
    media)
      case "$nm_rebuilder" in
        virtualbox|vmware|parallels)
          env LIMBO_FAKE=1 $cmd_guest destroy -f
          $nm_rebuilder build "$nm_basebox_build"
          $nm_rebuilder remove 2>&- || true
          $nm_rebuilder add
          ;;
        aws)
          env LIMBO_FAKE=1 $cmd_guest destroy -f
          $nm_rebuilder build
          $nm_rebuilder remove 2>&- || true
          $nm_rebuilder add
          ;;
        docker)
          if [[ "$nm_guest" == "${BOX_NAME}" ]]; then
            export BASEBOX_SOURCE="ubuntu:trusty"
            export BASEBOX_TAG="packer"
            $nm_rebuilder build "$BASEBOX_SOURCE"
          else
            export BASEBOX_TAG="vagrant"
            docker commit "$(limbo ${BOX_NAME} id)" "${BASEBOX_NAME}:${BASEBOX_TAG}"
          fi
          ;;
      esac
      ;;
    export)
      local nm_export="${1:-}"
      local nm_suffix="${nm_export:+-${nm_export}}"
      case "$nm_rebuilder" in
        virtualbox)
          cat "${BASEBOX_CACHE}/.ssh/ssh-vagrant.pub" | $cmd_guest ssh tee -a '~ubuntu/.ssh/authorized_keys'
          $cmd_guest ssh sudo rm -rf /dev/.udev
          $cmd_guest ssh sudo rm -f /lib/udev/rules.d/75-persistent-net-generator.rules
          $cmd_guest ssh sudo rm -rf /var/lib/dhcp # TODO assumes only leases are here
          $cmd_guest ssh sudo mkdir -p /var/lib/dhcp
          $cmd_guest halt

          (set +f; rm -f "${BASEBOX_CACHE}/box/${BASEBOX_NAME}${nm_suffix}.ovf" ${BASEBOX_CACHE}/box/${BASEBOX_NAME}${nm_suffix}-disk*.vmdk)
          (set -x; VBoxManage export $($cmd_guest id) --ovf20 -o "${BASEBOX_CACHE}/box/${BASEBOX_NAME}${nm_suffix}.ovf")
          ;;
        vmware)
          $cmd_guest halt
          ;;
        docker)
          if [[ "$nm_guest" == "${BOX_NAME}" ]]; then
            docker commit "$($cmd_guest id)" "${BASEBOX_NAME}:vagrant"
          fi
          ;;
      esac
      ;;
    import)
      local nm_import="${1:-}"
      local nm_suffix="${nm_import:+-${nm_import}}"
      case "$nm_rebuilder" in
        docker)
          docker load -i "${BASEBOX_CACHE}/box/${BASEBOX_NAME}.docker"
          ;;
        virtualbox)
          $nm_rebuilder remove 2>&- || true
          $nm_rebuilder add
          ;;
      esac
      ;;
    recycle)
      $cmd_guest destroy -f 2>&- || true
      $cmd_guest build
      ;;
    rebuild)
      local nm_export="${1:-}"
      local nm_suffix="${nm_export:+-${nm_export}}"
      case "$nm_rebuilder" in
        virtualbox|vmware)
          case "$nm_rebuilder" in
            vmware)
              export BASEBOX_SOURCE="$($cmd_guest id)"
              ;;
            virtualbox)
              export BASEBOX_SOURCE="${BASEBOX_CACHE}/box/${BASEBOX_NAME}${nm_suffix}.ovf"
              ;;
          esac

          $nm_rebuilder build "$nm_basebox_build" "$basebox_type" "$nm_export" "$@"
          $cmd_guest destroy -f
          $nm_rebuilder remove 2>&- || true
          $nm_rebuilder add

          rm -f "$shome/cidata/meta-data"
          (cd $shome && make)
          ;;
        docker)
          export BASEBOX_SOURCE="${BASEBOX_NAME}:vagrant"
          if [[ "$nm_guest" == "${BOX_NAME}" ]]; then
            export BASEBOX_TAG="vagrant"
            $nm_rebuilder build
            docker images -a
            docker history "$BASEBOX_SOURCE" || true
            docker save -o "${BASEBOX_CACHE}/box/${BASEBOX_NAME}${nm_suffix}.docker" "$BASEBOX_SOURCE"
            docker history "$BASEBOX_SOURCE"
          fi
          ;;
      esac
      $cmd_guest destroy -f
      exec $cmd_guest up
      ;;
    up)
      exec parity "$nm_action" "$nm_guest" "$@"
      ;;
    destroy)
      exec vagrant "$nm_action" "$nm_guest" "$@"
      ;;
    ssh|rsync|scp)
      exec parity "$nm_action" "$nm_guest" "$@"
      ;;
    sync)
      if [[ "$#" == 0 ]]; then
        local pth_packages="${BASEBOX_CACHE}/packages/"$(echo "$(parity ssh "$nm_guest" uname -s)_$(parity ssh "$nm_guest" uname -r | cut -d- -f1 | cut -d. -f1-3)${PKG_HOME}" | tr / _ | tr . _ | perl -pe 's{__+}{_}')""
        set -- "$pth_packages"
      fi

      for pth_packages in "$@"; do
        parity "ssh" "$nm_guest" sudo install -d -o ubuntu -g ubuntu "$pth_packages"
        parity "rsync" "$nm_guest" -ia --delete --progress "$pth_packages/." "${nm_guest}:$pth_packages/"
      done
      ;;
    id)
      cat "$(set +f; ls -td "$VAGRANT_CWD/.vagrant/machines/$nm_guest"/*/id | head -1)"; echo
      ;;
    build)
      exec $cmd_guest up "$@"
      ;;
    remote)
      local quoted=()
      while [[ "$#" -gt 0 ]]; do
        if [[ -n "$1" ]]; then
          quoted+=($(printf '%q' "$1"))
        else
          quoted+=("''")
        fi
        shift
      done
      exec parity ssh "$nm_guest" "${quoted[@]}"
      ;;
    snapshot|box)
      exec vagrant "$nm_action" "$@"
      ;;
    *)
      exec vagrant "$nm_action" "$nm_guest" "$@"
      ;;
  esac
}
